// Archon Deploy UI Database Schema
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
}

// Project represents a deployment configuration
model Project {
  id          String   @id @default(cuid())
  name        String
  description String?
  mode        String   // "new" | "existing"
  techStack   String?  // Stored as JSON array
  status      String   @default("active") // "active" | "paused" | "archived"
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  deployments Deployment[]
  agents      Agent[]
  integrations Integration[]
  
  @@index([status])
}

// Deployment represents a specific deployment instance
model Deployment {
  id          String   @id @default(cuid())
  projectId   String
  status      String   @default("initializing") // "initializing" | "active" | "failed" | "completed"
  
  // Deployment metadata
  branch      String?
  commitSha   String?
  environment String   @default("production") // "development" | "staging" | "production"
  
  // Metrics
  startedAt   DateTime @default(now())
  completedAt DateTime?
  duration    Int?     // seconds
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]
  logs        ActivityLog[]
  
  @@index([projectId, status])
  @@index([status])
}

// Agent represents one of the 7 specialist AI agents
model Agent {
  id          String   @id @default(cuid())
  projectId   String
  type        String   // "frontend" | "backend" | "database" | "devops" | "qa" | "docs" | "techlead"
  name        String   // Display name
  status      String   @default("idle") // "idle" | "active" | "busy" | "error" | "offline"
  
  // Agent configuration
  config      String?  // JSON blob for agent-specific settings
  
  // Metrics
  tasksCompleted Int   @default(0)
  tasksActive    Int   @default(0)
  lastActiveAt   DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tasks       Task[]
  logs        ActivityLog[]
  
  @@unique([projectId, type])
  @@index([projectId, status])
}

// Task represents work assigned to an agent
model Task {
  id           String   @id @default(cuid())
  deploymentId String?
  agentId      String?
  
  title        String
  description  String?
  status       String   @default("pending") // "pending" | "in_progress" | "completed" | "failed" | "blocked"
  priority     Int      @default(3) // 1=urgent, 2=high, 3=normal, 4=low
  
  // External references
  externalId   String?  // e.g., Linear issue ID
  externalUrl  String?  // e.g., GitHub PR URL
  
  // Task metadata
  startedAt    DateTime?
  completedAt  DateTime?
  duration     Int?     // seconds
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  deployment   Deployment? @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  agent        Agent?      @relation(fields: [agentId], references: [id], onDelete: SetNull)
  logs         ActivityLog[]
  
  @@index([deploymentId, status])
  @@index([agentId, status])
  @@index([status, priority])
}

// Integration represents external service connections
model Integration {
  id          String   @id @default(cuid())
  projectId   String
  type        String   // "github" | "linear" | "slack"
  name        String
  enabled     Boolean  @default(true)
  
  // Connection details (encrypted in production)
  config      String   // JSON blob with credentials/settings
  
  // Metadata
  lastSyncAt  DateTime?
  status      String   @default("connected") // "connected" | "error" | "disabled"
  errorMessage String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  
  @@unique([projectId, type])
  @@index([projectId, enabled])
}

// ActivityLog represents audit trail and real-time events
model ActivityLog {
  id           String   @id @default(cuid())
  deploymentId String?
  agentId      String?
  taskId       String?
  
  type         String   // "deployment" | "task" | "agent" | "integration" | "system"
  level        String   @default("info") // "debug" | "info" | "warn" | "error"
  message      String
  metadata     String?  // JSON blob for additional context
  
  createdAt    DateTime @default(now())
  
  deployment   Deployment? @relation(fields: [deploymentId], references: [id], onDelete: Cascade)
  agent        Agent?      @relation(fields: [agentId], references: [id], onDelete: SetNull)
  task         Task?       @relation(fields: [taskId], references: [id], onDelete: Cascade)
  
  @@index([deploymentId, createdAt])
  @@index([type, level, createdAt])
  @@index([createdAt])
}
